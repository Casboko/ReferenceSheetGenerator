# MVPドキュメント群 要件定義（ReferenceSheetGenerator）

本書は、実装計画（implementation-plan.md）の内容をMVP開発で扱いやすい粒度・関心事に分割し、継続運用可能なドキュメント群へ再構成するための要件定義です。ここで定義する各ドキュメントは、単一責務・参照しやすさ・更新容易性を重視します。

## 基本原則

- 単一責務: 各ドキュメントは一つの目的/読者に最適化。
- 出典明記: 一次情報（Google公式Docs/SDK）へのリンクを必須化。
- トレーサビリティ: 仕様→実装→テストの往来ができる相互参照。
- DoD明確化: 各ドキュメントに完成定義(DoD)と更新トリガーを明記。
- 軽量・即時性: MVPでは最短で意思決定・実装を前進させる内容に限定。

## 文書群（作成対象と要件）

以下のファイル名は `_dev_docs/` 配下に作成します（必要に応じて今後 `docs/` へ昇格可能）。

### 1) mvp-prd.md（MVPプロダクト要件）
- 目的: MVPの目的・スコープ・非スコープ・成功指標を合意。
- 想定読者: PM/開発/デザイナ/関係者。
- 必須項目: 目的、対象ユーザ/ユースケース、機能スコープ、非機能（性能/セキュリティ最小要件）、成功指標、非スコープ、リスク上位3件と方針。
- 完成定義: スコープの曖昧さが残っていない。成功指標が計測可能。
- 更新トリガー: スコープ変更・KPI変更・主要リスク変動。

### 2) architecture.md（アーキテクチャ概要/方針）
- 目的: ステートレス方針とデータ/制約に基づく構成の全体像を共有。
- 想定読者: 全職能。
- 必須項目: システム構成図（フロント/バック/外部API）、ステートレス設計の根拠、Files API採用理由、代替案比較（チャット方式）、主要コンポーネント境界、エラーフローの位置づけ、採用技術（React 19/Vite 6/Node 22）。
- 完成定義: 実装者が迷わず層/責務を判断できる。
- 更新トリガー: 主要構成/依存が変わるとき。

### 3) adr/0001-stateless-vs-chat.md（ADR）
- 目的: ステートレス採用の意思決定を永続化。
- 想定読者: アーキ/レビュア。
- 必須項目: 背景、問題、決定、根拠、影響、代替案、ステータス。
- 完成定義: 反証可能な形で決定が記録されている。
- 更新トリガー: 決定の反転/再検討。

### 4) api-spec.md（バックエンドAPI仕様）
- 目的: `POST /api/upload`・`POST /api/generate` などの入出力契約を明文化。
- 想定読者: フロント/バック実装者、QA。
- 必須項目: エンドポイント一覧、認証/レート制限、リクエスト/レスポンスJSONスキーマ、エラーコードと再試行方針、制約（3画像/7MB、出力最大10枚、Files URI参照）、例。
- 完成定義: モック/実装がこの定義のみで整合を保てる。
- 更新トリガー: パラメータ/エンドポイント/制約の変更。

### 5) gemini-integration.md（Gemini/Files API連携仕様）
- 目的: モデル呼び出しの詳細・制限・費用・安全性の一次情報集約。
- 想定読者: 実装/運用。
- 必須項目: モデルID、`responseModalities=["TEXT","IMAGE"]` 必須、入力3枚/各7MB、出力最大10枚、候補数、Files API（保存48h/20GB/2GB）、料金目安、レート制限、SynthIDの扱い、安全フィルタ、SDK利用例。
- 完成定義: 実装者が追加調査なく正しく呼び出せる。
- 更新トリガー: モデル仕様/料金/SDK更新。

### 6) ui-ux-spec.md（UI/UX仕様）
- 目的: 3参照スロットと「直前出力を参照」トグル中心の操作を定義。
- 想定読者: フロント/デザイン/QA。
- 必須項目: 主要画面、状態遷移、スロット/トグル挙動、ドラッグ&ドロップ、エンプティ/ローディング/エラー表示、日本語メッセージ方針、アクセシビリティ最小要件。
- 完成定義: 実装がワイヤなしでも破綻しない粒度で網羅。
- 更新トリガー: 交互仕様/コンポーネント構成の変更。

### 7) state-model.md（データ/状態モデル）
- 目的: `Asset`/`slots`/`lastOutputId` 等のアプリ状態と更新規則を定義。
- 想定読者: 実装/QA。
- 必須項目: エンティティ図、型定義（TypeScript擬似コード可）、不変条件、主なイベントとリデューサ、永続/揮発の切り分け、サイズ制約の扱い。
- 完成定義: 実装者が安全に状態更新を書ける。
- 更新トリガー: 型/状態遷移の変更。

### 8) prompts-spec.md（プロンプト設計）
- 目的: `lib/prompts.ts` の方針（MVPでは極力生テキスト）と将来拡張。
- 想定読者: 実装/プロンプトデザイナ。
- 必須項目: MVPの入力方針、禁止語/安全配慮、温度/候補数の既定値、画像編集指示の定型、将来のテンプレート化案。
- 完成定義: プロンプトの一貫性と安全が担保される。
- 更新トリガー: 出力品質要件/モデル特性の変化。

### 9) error-handling.md（エラー/再試行/文言）
- 目的: 再試行ロジック、ユーザ向け日本語文言、想定失敗の一覧を共有。
- 想定読者: 実装/QA/CS。
- 必須項目: 典型失敗（429/5xx/サイズ超過/安全ブロック）、再試行ポリシー、ユーザ通知メッセージ、ログ設計の要点。
- 完成定義: 障害時の挙動が揺らがない。
- 更新トリガー: 失敗モード追加/ポリシー変更。

### 10) security-config.md（セキュリティ/設定）
- 目的: APIキー秘匿、環境変数、CORS、公開ビルドの安全策を整理。
- 想定読者: バック/運用。
- 必須項目: `.env.local`/ビルド時注入、ブラウザ直呼びの是非、プロキシ構成案、権限分離、画像データ取扱注意点、GDPR/ライセンス簡易チェック。
- 完成定義: 秘密情報がフロントに露出しない。
- 更新トリガー: 配布形態/インフラ変更。

### 11) performance-ops.md（性能/運用/監視）
- 目的: レート制限対策、バックオフ、スロットリング、ログ/モニタリング。
- 想定読者: 実装/運用。
- 必須項目: 想定RPS、バックオフ式、同時実行上限、計測指標（成功率/遅延/コスト）、アラート初期値、コスト管理のガードレール。
- 完成定義: 初期運用で困らない最小セットが揃う。
- 更新トリガー: 負荷/料金/障害傾向の変化。

### 12) testing-plan.md（テスト計画）
- 目的: Vitest+RTL前提のMVPテスト範囲と実行方法を定義。
- 想定読者: 開発/QA。
- 必須項目: ユニット範囲、レンダリング/相互作用、モック方針（API/SDK）、スナップショット最小、手動確認チェックリスト、カバレッジ目標（軽量）。
- 完成定義: CIが赤/緑で判断できる最小テストが揃う。
- 更新トリガー: 仕様変更/バグ再発。

### 13) rollout-runbook.md（開発/デプロイ運用手順）
- 目的: ローカル/プレビュー/本番の手順とロールバック方針を統一。
- 想定読者: 全職能。
- 必須項目: Node 22/.nvmrcの徹底、`npm run dev/build/preview`、APIキー配置、リリース手順、既知の落とし穴、トラブルシュート早見表。
- 完成定義: 新規メンバーでも自走可能。
- 更新トリガー: パイプラインやコマンド変更。

### 14) glossary.md（用語集）
- 目的: 用語の曖昧さ解消（例: スロット/アセット/候補/Files URI）。
- 想定読者: 全職能。
- 必須項目: 用語→定義→出典/備考。
- 完成定義: 会話・Issueで用語がブレない。
- 更新トリガー: 新用語追加/混同が見られた時。

### 15) roadmap.md（短期ロードマップ）
- 目的: MVP→α→βの段階的拡張ポイントを整理。
- 想定読者: PM/開発。
- 必須項目: マイルストン、ゴール、主要課題、エピック一覧、外部依存。
- 完成定義: 2スプリント先までの見通しが取れる。
- 更新トリガー: 計画変更。

## 既存計画からの対応表（抜粋）

- 1.仕様確認 → 5) gemini-integration.md, 11) performance-ops.md
- 2.リポジトリ監査 → 2) architecture.md（現状評価セクション）
- 3.アーキテクチャ提案 → 2) architecture.md, 3) ADR
- 4.データ/API設計 → 4) api-spec.md, 7) state-model.md
- 5.UI/UX設計 → 6) ui-ux-spec.md
- 6.実装計画 → 13) runbook, 15) roadmap
- 7.テスト計画 → 12) testing-plan.md
- 8.コスト/運用/監視 → 11) performance-ops.md
- 9.リスクと対応策 → 1) mvp-prd.md（非機能/リスク）, 2) architecture.md
- 10.ロードマップ → 15) roadmap.md

## 作成・運用ルール

- スタイル: Markdown, 日本語、短い段落と箇条書き中心。図は必要最低限（テキストベースの図でも可）。
- 命名/配置: 上記ファイル名で `_dev_docs/` 直下。ADRは `_dev_docs/adr/` 配下。
- リンク: 相互参照を相対パスで。一次情報はURLを明記。
- 更新手順: 変更はPRで。Conventional Commitsの `docs(...)` を使用。主要決定はADRに追記。
- レビュー観点: 読者/目的が明確か、DoD/更新トリガーが書かれているか、出典が妥当か。

## 初回作成の進め方（チェックリスト）

1. 1) mvp-prd.md をドラフト（MVPスコープ/成功指標/非スコープ）。
2. 2) architecture.md に構成図とステートレス根拠を反映。
3. 4) api-spec.md に `/api/upload` と `/api/generate` の入出力を定義。
4. 6) ui-ux-spec.md にスロット/トグル挙動と主要画面状態を記述。
5. 7) state-model.md に型/状態遷移を定義。
6. 5) gemini-integration.md へモデル/Files仕様と制約を集約。
7. 9) error-handling.md と 11) performance-ops.md を最小で用意。
8. 12) testing-plan.md を軽量に（実行コマンド/対象範囲）。
9. 13) rollout-runbook.md にローカル～プレビュー手順を記載。

上記8～9まで整えば、MVP実装を安全に進められる基盤が揃います。

---

付記: 本要件定義はMVPフェーズに特化した最小構成です。GA対応/本番運用に移行する際はセキュリティレビュー、DPA/法務、SLO/アラート強化、UIアクセシビリティ拡張などのドキュメントを別途拡充してください。

